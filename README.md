# DSC-Azure-machine-config-demo
Demo Azure Machine configuration with DSC and PowerShell

there are some requirement 

- a windows machine with PowerShell 7
- an Azure tenant
- VS Code
- GuestConfiguration PwSh module
- an azure Storage Account


## DSC 

First we need to configure the local machine

instal THE PSDesiredStateConfiguration
But besure to not install the 3.0 version

```powershell
install-module -name PSDesiredStateConfiguration -Repository PSGallery -MaximumVersion 2.99 -force
```

and the PsdResources module

```powershell
install-module -name PsdscResources -Repository PSGallery -force
```

now we can load the config file in the DSC folder and compile the DSC configuration

```powershell 
. .\demo.dsc.ps1
demoDevTo
```

As a result we have a loacalhost.mof file in the demoDecTo folder

The next step is to create a configuration package that will be consume by Azure Machine configuration
First we need to rename the localhost.mof file to demodevto.mof

```powershell
rename-item -path .\demoDevTo\localhost.mof -NewName "demodevto.mof" -passThru
```

Then we can create the package we can use audit or enforce here we use enforce

```powershell
new-GuestConfiguration -name "demodevto" -type "AuditAndSet" -Configuration ".\demoDevTo\demodevto.mof" -force $true 
```

The zip file, demodevto.zip, generated by the new-GuestConfiguration can be send to the container in a storage account

```powershell
$storageAccount = get-azStorageAccount -name "demodscomc001" -resourcegroup "demo-dsc"


set-azStorageBlob -container "packages" -file ".\demodevto.zip" -blob "demodevto.zip" -context $storageAccount.context -force 
```

## VM requierement 

The Guest Configuration package can be only apply to a VM if it had a managed identity and the Microsoft.Guestconfiguration extension.
The managed identity and the extension can be enabled via Azure Policy

## Delivering the package

### Bicep

### Azure Policy
