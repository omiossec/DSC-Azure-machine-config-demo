# DSC-Azure-machine-config-demo
Demo Azure Machine configuration with DSC and PowerShell

there are some requirement 

- a windows machine with PowerShell 7
- an Azure tenant
- VS Code
- GuestConfiguration PwSh module
- an azure Storage Account

## DSC

First we need to configure the local machine

instal THE PSDesiredStateConfiguration
But besure to not install the 3.0 version

```powershell
install-module -name PSDesiredStateConfiguration -Repository PSGallery -MaximumVersion 2.99 -force
```

and the PsdResources module

```powershell
  install-module -name PsdscResources -Repository PSGallery -force
```

Finally the GuestConfiguration module is also needed

```powershell
Install-Module -Name GuestConfiguration -Repository PSGallery
```

now we can load the config file in the DSC folder and compile the DSC configuration

```powershell 
. .\demo.dsc.ps1
demoDevTo
```

As a result we have a loacalhost.mof file in the demoDecTo folder

The next step is to create a configuration package that will be consume by Azure Machine configuration
First we need to rename the localhost.mof file to demodevto.mof

```powershell
rename-item -path .\demoDevTo\localhost.mof -NewName "demodevto.mof" -passThru
```

Then we can create the package we can use audit or enforce here we use enforce

```powershell
New-GuestConfigurationPackage -name "demodevto" -type "AuditAndSet" -Configuration ".\demoDevTo\demodevto.mof" -force $true 
```

The zip file, demodevto.zip, generated by the new-GuestConfiguration can be send to the container in a storage account

```powershell
$storageAccount = get-azStorageAccount -name "demodscomc001" -resourcegroup "demo-dsc"


set-azStorageBlobContent -container "packages" -file ".\demodevto.zip" -blob "demodevto.zip" -context $storageAccount.context -force 
```

## VM requierement 

The Guest Configuration package can be only apply to a VM if it had a managed identity and the Microsoft.Guestconfiguration extension.
The managed identity and the extension can be enabled via Azure Policy

The 2 policies install the extension and configure the VM to use a system 

## Delivering the package

There are two way to deliver the package to a VM. You can deploy on each VM with IaC like Bicep, ARM Template or Terraform, or at scale by using Azure Policy.

For both we need to have the SAS URI for the package 

```powershell
$today = Get-Date
$expirationDate = $today.AddYears(1)



$strPackageURI = New-AzStorageBlobSASToken -Context $storageAccount.context -Container "packages" -Blob "demodevto.zip" -Permission racwd -ExpiryTime $expirationDate -FullUri
```

### Bicep

The first to do is to get the SHA256 of the package file created by the gest configuration command

```powershell
$packageHash = Get-FileHash -Path ./demodevto.zip -Algorithm SHA256
```

We also need to get the SAS uri of the package in the storage account 


```powershell
$expiryTime = (Get-Date).AddYears(1) 
$permissions = "r"

$sasToken = New-AzStorageBlobSASToken -Container "packages" -Blob "demodevto.zip" -Context $storageAccount.context -ExpiryTime $expiryTime -Permission $permissions -FullUri
```


```bicep
resource myVM 'Microsoft.Compute/virtualMachines@2021-03-01' existing = {
  name: '<vm_name>'
}

resource myConfiguration 'Microsoft.GuestConfiguration/guestConfigurationAssignments@2020-06-25' = {
  name: '<configuration_name>'
  scope: myVM
  location: resourceGroup().location
  properties: {
    guestConfiguration: {
      name: '<configuration_name>'
      contentUri: '<Url_to_Package.zip>'
      contentHash: '<SHA256_hash_of_package.zip>'
      version: '1.*'
      assignmentType: 'ApplyAndMonitor'
    }
  }
}
```


### Azure Policy

```powershell

$guid = new-guid


$PolicyConfig      = @{
  PolicyId      = $guid.Guid
  ContentUri    = $contentUri
  DisplayName   = 'My audit policy'
  Description   = 'My audit policy'
  Path          = './policies/auditIfNotExists.json'
  Platform      = 'Windows'
  PolicyVersion = 1.0.0
}

New-GuestConfigurationPolicy @PolicyConfig
```
